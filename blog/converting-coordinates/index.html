<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;style-src 'self';frame-src https://www.youtube-nocookie.com 'self' giscus.app;connect-src 'self' jmbhughes-stats.goatcounter.com/count;script-src 'self' gc.zgo.at  giscus.app 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://jmbhughes.com/">

    
    <title>
jmbhughes • Converting helioprojective to equatorial</title>

    
    
        <link rel="icon" type="image/png" href="https://jmbhughes.com/icons/favicon.ico"/>
    
    

    
    
        
            
            
                
                    <link rel="alternate" type="application/atom+xml" title="jmbhughes - Atom Feed" href="https://jmbhughes.com/atom.xml">
                
            
        
    

    
    
    
        
            <link rel="stylesheet" href="https://jmbhughes.com/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://jmbhughes.com/main.css?h=045c365e19a4d50a64bb" />
        <link rel="stylesheet" href="https://jmbhughes.com/skins/mint.css?h=504215cf6bc10586b487" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="Change between world coordinate systems using Astropy and SunPy" />
        <meta property="og:description" content="Change between world coordinate systems using Astropy and SunPy" />

    

    <meta property="og:title" content="Converting helioprojective to equatorial" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;jmbhughes.com&#x2F;blog&#x2F;converting-coordinates&#x2F;" /><meta property="og:site_name" content="jmbhughes">
        <noscript><link rel="stylesheet" href="https://jmbhughes.com/no_js.css"/></noscript>
        <script type="text/javascript" src="https://jmbhughes.com/js/initializeTheme.min.js"></script>
        <script defer src="https://jmbhughes.com/js/themeSwitcher.min.js"></script>




    
    
    <script async
    
        data-goatcounter="https://jmbhughes-stats.goatcounter.com/count"
        src="https://gc.zgo.at/count.js"
        
    ></script>
    



        <script defer src="https://jmbhughes.com/js/searchElasticlunr.min.js?h=69d4be9bc2f0a8301299"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://jmbhughes.com/">jmbhughes</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://jmbhughes.com/archive/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://jmbhughes.com/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://jmbhughes.com/about/">about
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://jmbhughes.com/news/">news
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            Converting helioprojective to equatorial
        </h1>
        <a class="u-url u-uid" href="https://jmbhughes.com/blog/converting-coordinates/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;jmbhughes.com&#x2F;" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2024-08-15">15th Aug 2024</time></li><li title="471 words"><span class='separator' aria-hidden='true'>•</span>3 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://jmbhughes.com/tags/solar/">solar</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://jmbhughes.com/tags/programming/">programming</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://jmbhughes.com/tags/python/">python</a></li>
        </ul>
            

<div class="toc-container">
    
        <h3>Table of Contents</h3>
    

    <ul>
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#introduction">Introduction</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#converting-a-single-coordinate">Converting a single coordinate</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#transforming-a-wcs-from-helio-to-celestial">Transforming a WCS from helio to celestial</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#transforming-the-opposite-direction">Transforming the opposite direction</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#verifying">Verifying</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#conclusions">Conclusions</a>
                    
                </li>
            
        
    </ul>
</div>


        
            <p class="p-summary" hidden>Change between world coordinate systems using Astropy and SunPy</p><section class="e-content body"><h2 id="introduction"><a class="header-anchor no-hover-padding" href="#introduction" aria-label="Anchor link for: introduction"><span class="link-icon" aria-hidden="true"></span></a>
Introduction</h2>
<p>Solar physics and nighttime astronomy often use different but related coordinate systems.
In solar physics, the helioprojective coordinate system is common. Depending on the subfield
of astronomy one might use a variety of coordinate systems, but one of the most common is equatorial.
These are both spherical geometries.</p>
<p>However, it turns out to be a bit complicated to convert directly between the two. Astropy and SunPy
offer utilities to do the conversion, but I was running into some challenges. I asked Sam Van Kooten for
help, and we came up with this solution. It only applies when the observer is the center of the Earth though.</p>
<h2 id="converting-a-single-coordinate"><a class="header-anchor no-hover-padding" href="#converting-a-single-coordinate" aria-label="Anchor link for: converting-a-single-coordinate"><span class="link-icon" aria-hidden="true"></span></a>
Converting a single coordinate</h2>
<p>First, we need to know how to convert a single coordinate.</p>
<p>Astropy has a system of transormations that form a computational graph. SunPy augments this with the
common solar coordinate systems. If we try to convert helioprojective to GCRS, we’ll be doing several
steps of conversions: Helioprojective to Heliocentric to HeliographicStonyhurst to HCRS to ICRS and finally to GCRS.
This shouldn’t really be required. So, we’ll register a new transformation that goes from helioprojective straight to GCRS.</p>
<pre class="giallo z-code"><code data-lang="python"><span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span></span>
<span class="giallo-l"><span class="z-keyword">from</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">io</span><span class="z-keyword"> import</span><span class="z-source"> fits</span></span>
<span class="giallo-l"><span class="z-keyword">from</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">wcs</span><span class="z-keyword"> import</span><span class="z-source"> WCS</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> matplotlib</span><span class="z-punctuation">.</span><span class="z-source">pyplot</span><span class="z-keyword"> as</span><span class="z-source"> plt</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> numpy</span><span class="z-keyword"> as</span><span class="z-source"> np</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> sunpy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> _times_are_equal</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">time_1</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">time</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">Time</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> time_2</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">time</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">Time</span><span class="z-punctuation">) -&gt;</span><span class="z-support z-type z-python"> bool</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Ripped from sunpy, modified</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Checks whether times are equal</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-support z-function z-builtin z-python"> isinstance</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">time_1</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">time</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Time</span><span class="z-punctuation">)</span><span class="z-keyword z-operator z-logical z-python"> and</span><span class="z-support z-function z-builtin z-python"> isinstance</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">time_2</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">time</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Time</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">        # We explicitly perform the check in TAI to avoid possible numerical precision differences</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">        # between a time in UTC and the same time after a UTC-&gt;TAI-&gt;UTC conversion</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        return</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">all</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">time_1</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">tai</span><span class="z-keyword z-operator"> ==</span><span class="z-meta z-function-call z-arguments z-python"> time_2</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">tai</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # We also deem the times equal if one is None</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> time_1</span><span class="z-keyword z-operator z-logical z-python"> is</span><span class="z-constant z-language z-python"> None</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-source"> time_2</span><span class="z-keyword z-operator z-logical z-python"> is</span><span class="z-constant z-language z-python"> None</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> get_p_angle</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">time</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;now&quot;</span><span class="z-punctuation">) -&gt;</span><span class="z-source"> u</span><span class="z-punctuation">.</span><span class="z-source">deg</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-string">    Get the P angle.</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-string">    Return the position (P) angle for the Sun at a specified time, which is the angle between</span></span>
<span class="giallo-l"><span class="z-string">    geocentric north and solar north as seen from Earth, measured eastward from geocentric north.</span></span>
<span class="giallo-l"><span class="z-string">    The range of P is +/-26.3 degrees.</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-string">    Parameters</span></span>
<span class="giallo-l"><span class="z-string">    ----------</span></span>
<span class="giallo-l"><span class="z-string">    time : {parse_time_types}</span></span>
<span class="giallo-l"><span class="z-string">        Time to use in a parse_time-compatible format</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-string">    Returns</span></span>
<span class="giallo-l"><span class="z-string">    -------</span></span>
<span class="giallo-l"><span class="z-string">    out : `~astropy.coordinates.Angle`</span></span>
<span class="giallo-l"><span class="z-string">        The position angle</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    obstime</span><span class="z-keyword z-operator"> =</span><span class="z-source"> sunpy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-source">sun</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">parse_time</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">time</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Define the frame where its Z axis is aligned with geocentric north</span></span>
<span class="giallo-l"><span class="z-source">    geocentric</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">GCRS</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">obstime</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> sunpy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-source">sun</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">_sun_north_angle_to_z</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">geocentric</span><span class="z-punctuation">)</span><span class="z-punctuation z-definition z-comment z-comment">  # noqa: SLF001</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-decorator z-python z-entity z-name z-function z-decorator z-python">@astropy</span><span class="z-punctuation">.</span><span class="z-entity z-name z-function z-decorator z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-entity z-name z-function z-decorator z-python">frame_transform_graph</span><span class="z-punctuation">.</span><span class="z-entity z-name z-function z-decorator z-python">transform</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">    astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">FunctionTransform</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">    sunpy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Helioprojective</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">    astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">GCRS</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> hpc_to_gcrs</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">HPcoord</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> GCRSframe</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python z-keyword z-operator z-logical z-python">    if not</span><span class="z-meta z-function-call z-python"> _times_are_equal</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">HPcoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> GCRSframe</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        raise</span><span class="z-support z-type z-exception z-python"> ValueError</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;Obstimes are not equal&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    obstime</span><span class="z-keyword z-operator"> =</span><span class="z-source"> HPcoord</span><span class="z-punctuation">.</span><span class="z-source">obstime</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-source"> GCRSframe</span><span class="z-punctuation">.</span><span class="z-source">obstime</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Compute the three angles we need</span></span>
<span class="giallo-l"><span class="z-source">    position</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get_sun</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    ra</span><span class="z-punctuation">,</span><span class="z-source"> dec</span><span class="z-keyword z-operator"> =</span><span class="z-source"> position</span><span class="z-punctuation">.</span><span class="z-source">ra</span><span class="z-punctuation">.</span><span class="z-source">rad</span><span class="z-punctuation">,</span><span class="z-source"> position</span><span class="z-punctuation">.</span><span class="z-source">dec</span><span class="z-punctuation">.</span><span class="z-source">rad</span></span>
<span class="giallo-l"><span class="z-source">    p</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> P</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">).</span><span class="z-source">rad</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Prepare rotation matrices for each</span></span>
<span class="giallo-l"><span class="z-source">    p_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">array</span><span class="z-punctuation">([</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">),</span><span class="z-keyword z-operator"> -</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">)],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">),</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">)]</span></span>
<span class="giallo-l"><span class="z-punctuation">    ])</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    ra_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">array</span><span class="z-punctuation">([</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-keyword z-operator"> -</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">]</span></span>
<span class="giallo-l"><span class="z-punctuation">    ])</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    dec_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">array</span><span class="z-punctuation">([</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">)],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">)]</span></span>
<span class="giallo-l"><span class="z-punctuation">    ])</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Compose the matrices</span></span>
<span class="giallo-l"><span class="z-source">    matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> ra_matrix</span><span class="z-keyword z-operator"> @</span><span class="z-source"> dec_matrix</span><span class="z-keyword z-operator"> @</span><span class="z-source"> p_matrix</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Extract the input coordinates and negate the HP latitude,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # since it increases in the opposite direction from RA.</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-source"> HPcoord</span><span class="z-punctuation">.</span><span class="z-source">_is_2d</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">UnitSphericalRepresentation</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-keyword z-operator">            -</span><span class="z-meta z-function-call z-arguments z-python">HPcoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Tx</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> HPcoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Ty</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    else</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">SphericalRepresentation</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-keyword z-operator">            -</span><span class="z-meta z-function-call z-arguments z-python">HPcoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Tx</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> HPcoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Ty</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> HPcoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">distance</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Apply the tranformation</span></span>
<span class="giallo-l"><span class="z-source">    rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">to_cartesian</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-source">    rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">transform</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">matrix</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Match the input representation. (If the input was UnitSpherical, meaning there&#39;s no</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # distance coordinate, this drops the distance coordinate.)</span></span>
<span class="giallo-l"><span class="z-source">    rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">represent_as</span><span class="z-punctuation">(</span><span class="z-support z-type z-python">type</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">HPcoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">data</span><span class="z-punctuation">))</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Put the computed coordinates into the output frame</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> GCRSframe</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">realize_frame</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">rep</span><span class="z-punctuation">)</span></span></code></pre>
<p>The meat of the transformation happens when setting up the matrices in the last function.
They’re rotation matrices to go from one to the other using the Sun’s right ascension and declination coupled with the solar P angle.
We carefully use the P angle in GCRS instead of SunPy’s built-in <code>sun.P</code>, which I believe uses ITRS.</p>
<p>We can then use Astropy’s infrastructure for conversions.</p>
<pre class="giallo z-code"><code data-lang="python"><span class="giallo-l"><span class="z-source">helio_coord</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> SkyCoord</span><span class="z-punctuation">(</span><span class="z-constant z-numeric">1</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 3</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">                     frame</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;helioprojective&quot;</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> observer</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;earth&quot;</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> obstime</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">date_obs</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">eq_coord</span><span class="z-keyword z-operator"> =</span><span class="z-source"> old_crval</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">transform_to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">GCRS</span><span class="z-punctuation">)</span></span></code></pre>
<p>It’s quite nifty.</p>
<h2 id="transforming-a-wcs-from-helio-to-celestial"><a class="header-anchor no-hover-padding" href="#transforming-a-wcs-from-helio-to-celestial" aria-label="Anchor link for: transforming-a-wcs-from-helio-to-celestial"><span class="link-icon" aria-hidden="true"></span></a>
Transforming a WCS from helio to celestial</h2>
<p>So let’s say you have a world coordinate system in helioprojective. How can you use this to convert to GCRS?</p>
<p>First, you transform the CRVAL using the coordinate transform we just defined.
Then, you transform the PC matrix by rotating by the P angle.</p>
<pre class="giallo z-code"><code data-lang="python"><span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> extract_crota_from_wcs</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">wcs</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> WCS</span><span class="z-punctuation">) -&gt;</span><span class="z-source"> u</span><span class="z-punctuation">.</span><span class="z-source">deg</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">    &quot;&quot;&quot;Extract CROTA from a WCS.&quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">arctan2</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">pc</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span><span class="z-meta z-function-call z-arguments z-python"> wcs</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">pc</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">])</span><span class="z-keyword z-operator"> *</span><span class="z-source"> u</span><span class="z-punctuation">.</span><span class="z-source">rad</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> calculate_pc_matrix</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">crota</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">deg</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> cdelt</span><span class="z-punctuation">: (</span><span class="z-support z-type z-python">float</span><span class="z-punctuation">,</span><span class="z-support z-type z-python"> float</span><span class="z-punctuation">)) -&gt;</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-source">ndarray</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-string">    Calculate a PC matrix given CROTA and CDELT.</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-string">    Parameters</span></span>
<span class="giallo-l"><span class="z-string">    ----------</span></span>
<span class="giallo-l"><span class="z-string">    crota : float</span></span>
<span class="giallo-l"><span class="z-string">        rotation angle from the WCS</span></span>
<span class="giallo-l"><span class="z-string">    cdelt : float</span></span>
<span class="giallo-l"><span class="z-string">        pixel size from the WCS</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-string">    Returns</span></span>
<span class="giallo-l"><span class="z-string">    -------</span></span>
<span class="giallo-l"><span class="z-string">    np.ndarray</span></span>
<span class="giallo-l"><span class="z-string">        PC matrix</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">array</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span></span>
<span class="giallo-l"><span class="z-punctuation">            [</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">crota</span><span class="z-punctuation">),</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">crota</span><span class="z-punctuation">)</span><span class="z-keyword z-operator"> *</span><span class="z-punctuation"> (</span><span class="z-meta z-indexed-name z-python">cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> /</span><span class="z-meta z-indexed-name z-python"> cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">])],</span></span>
<span class="giallo-l"><span class="z-punctuation">            [</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">crota</span><span class="z-punctuation">)</span><span class="z-keyword z-operator"> *</span><span class="z-punctuation"> (</span><span class="z-meta z-indexed-name z-python">cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> /</span><span class="z-meta z-indexed-name z-python"> cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">]),</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">crota</span><span class="z-punctuation">)],</span></span>
<span class="giallo-l"><span class="z-punctuation">        ],</span></span>
<span class="giallo-l"><span class="z-punctuation">    )</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> calculate_celestial_wcs_from_helio</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">    wcs_helio</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> WCS</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">    date_obs</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> datetime</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">    data_shape</span><span class="z-punctuation">:</span><span class="z-meta z-indexed-name z-python"> tuple</span><span class="z-punctuation">[</span><span class="z-support z-type z-python">int</span><span class="z-punctuation">,</span><span class="z-support z-type z-python"> int</span><span class="z-punctuation">]) -&gt;</span><span class="z-source"> WCS</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">    &quot;&quot;&quot;Calculate the celestial WCS from a helio WCS.&quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    is_3d</span><span class="z-keyword z-operator"> =</span><span class="z-support z-function z-builtin z-python"> len</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">data_shape</span><span class="z-punctuation">)</span><span class="z-keyword z-operator"> ==</span><span class="z-constant z-numeric"> 3</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    old_crval</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> SkyCoord</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_helio</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crval</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> wcs_helio</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crval</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">                            frame</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;helioprojective&quot;</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> observer</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;earth&quot;</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> obstime</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">date_obs</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    new_crval</span><span class="z-keyword z-operator"> =</span><span class="z-source"> old_crval</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">transform_to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">GCRS</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    rotation_angle</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> extract_crota_from_wcs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_helio</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">rad</span><span class="z-punctuation">).</span><span class="z-source">value</span><span class="z-keyword z-operator"> -</span><span class="z-meta z-function-call z-python"> get_p_angle</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">date_obs</span><span class="z-punctuation">).</span><span class="z-source">rad</span></span>
<span class="giallo-l"><span class="z-source">    new_pc_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> calculate_pc_matrix</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">rotation_angle</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> wcs_helio</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">cdelt</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    cdelt1</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">abs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_helio</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">])</span><span class="z-keyword z-operator"> *</span><span class="z-source"> u</span><span class="z-punctuation">.</span><span class="z-source">deg</span></span>
<span class="giallo-l"><span class="z-source">    cdelt2</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">abs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_helio</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">])</span><span class="z-keyword z-operator"> *</span><span class="z-source"> u</span><span class="z-punctuation">.</span><span class="z-source">deg</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    projection_code</span><span class="z-keyword z-operator"> =</span><span class="z-source"> wcs_helio</span><span class="z-punctuation">.</span><span class="z-source">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">ctype</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">][</span><span class="z-keyword z-operator">-</span><span class="z-constant z-numeric">3</span><span class="z-punctuation">:]</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    wcs_celestial</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> WCS</span><span class="z-punctuation">({</span><span class="z-punctuation z-definition z-string z-string">&quot;CRVAL1&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-function-call z-arguments z-python"> new_crval</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-arguments z-python">value</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CRVAL2&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-function-call z-arguments z-python"> new_crval</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-arguments z-python">value</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CUNIT1&quot;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &quot;deg&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CUNIT2&quot;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &quot;deg&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CRPIX1&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-function-call z-arguments z-python"> wcs_helio</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crpix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CRPIX2&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-function-call z-arguments z-python"> wcs_helio</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crpix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CDELT1&quot;</span><span class="z-punctuation">:</span><span class="z-keyword z-operator"> -</span><span class="z-meta z-function-call z-arguments z-python">cdelt1</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-arguments z-python">value</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CDELT2&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-function-call z-arguments z-python"> cdelt2</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-arguments z-python">value</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CTYPE1&quot;</span><span class="z-punctuation">:</span><span class="z-storage z-type z-string z-python"> f</span><span class="z-string">&quot;RA---</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-meta z-function-call z-arguments z-python">projection_code</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;CTYPE2&quot;</span><span class="z-punctuation">:</span><span class="z-storage z-type z-string z-python"> f</span><span class="z-string">&quot;DEC--</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-meta z-function-call z-arguments z-python">projection_code</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;PC1_1&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-indexed-name z-python"> new_pc_matrix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;PC1_2&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-indexed-name z-python"> new_pc_matrix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;PC2_1&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-indexed-name z-python"> new_pc_matrix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">                            &quot;PC2_2&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-indexed-name z-python"> new_pc_matrix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">]},</span></span>
<span class="giallo-l"><span class="z-punctuation">                        )</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-source"> is_3d</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        wcs_celestial</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> add_stokes_axis_to_wcs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 2</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> wcs_celestial</span></span></code></pre>
<p>Since this code was developed for PUNCH, we have a polarization axis that makes this WCS 3D in some cases.
So, we handle that here too.</p>
<h2 id="transforming-the-opposite-direction"><a class="header-anchor no-hover-padding" href="#transforming-the-opposite-direction" aria-label="Anchor link for: transforming-the-opposite-direction"><span class="link-icon" aria-hidden="true"></span></a>
Transforming the opposite direction</h2>
<p>You can reverse this too!</p>
<pre class="giallo z-code"><code data-lang="python"><span class="giallo-l"><span class="z-punctuation z-definition z-decorator z-python z-entity z-name z-function z-decorator z-python">@astropy</span><span class="z-punctuation">.</span><span class="z-entity z-name z-function z-decorator z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-entity z-name z-function z-decorator z-python">frame_transform_graph</span><span class="z-punctuation">.</span><span class="z-entity z-name z-function z-decorator z-python">transform</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">    astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">FunctionTransform</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">    astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">GCRS</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">    sunpy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">Helioprojective</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> gcrs_to_hpc</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">GCRScoord</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> Helioprojective</span><span class="z-punctuation">):</span><span class="z-punctuation z-definition z-comment z-comment"> # noqa: ANN201, N803, ANN001</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">    &quot;&quot;&quot;Convert GCRS to HPC.&quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python z-keyword z-operator z-logical z-python">    if not</span><span class="z-meta z-function-call z-python"> _times_are_equal</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> Helioprojective</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        raise</span><span class="z-support z-type z-exception z-python"> ValueError</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;Obstimes are not equal&quot;</span><span class="z-punctuation">)</span><span class="z-punctuation z-definition z-comment z-comment">  # noqa: TRY003, EM101</span></span>
<span class="giallo-l"><span class="z-source">    obstime</span><span class="z-keyword z-operator"> =</span><span class="z-source"> GCRScoord</span><span class="z-punctuation">.</span><span class="z-source">obstime</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-source"> Helioprojective</span><span class="z-punctuation">.</span><span class="z-source">obstime</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Compute the three angles we need</span></span>
<span class="giallo-l"><span class="z-source">    position</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get_sun</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    ra</span><span class="z-punctuation">,</span><span class="z-source"> dec</span><span class="z-keyword z-operator"> =</span><span class="z-source"> position</span><span class="z-punctuation">.</span><span class="z-source">ra</span><span class="z-punctuation">.</span><span class="z-source">rad</span><span class="z-punctuation">,</span><span class="z-source"> position</span><span class="z-punctuation">.</span><span class="z-source">dec</span><span class="z-punctuation">.</span><span class="z-source">rad</span></span>
<span class="giallo-l"><span class="z-source">    p</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> get_p_angle</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">obstime</span><span class="z-punctuation">).</span><span class="z-source">rad</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Prepare rotation matrices for each</span></span>
<span class="giallo-l"><span class="z-source">    p_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">array</span><span class="z-punctuation">([</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">),</span><span class="z-keyword z-operator"> -</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">)],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">),</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">p</span><span class="z-punctuation">)],</span></span>
<span class="giallo-l"><span class="z-punctuation">    ])</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    ra_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">array</span><span class="z-punctuation">([</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-keyword z-operator"> -</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">    ])</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    dec_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">array</span><span class="z-punctuation">([</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">)],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">],</span></span>
<span class="giallo-l"><span class="z-punctuation">        [</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sin</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">),</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">cos</span><span class="z-punctuation">(</span><span class="z-keyword z-operator">-</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">)],</span></span>
<span class="giallo-l"><span class="z-punctuation">    ])</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Compose the matrices</span></span>
<span class="giallo-l"><span class="z-source">    old_matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> ra_matrix</span><span class="z-keyword z-operator"> @</span><span class="z-source"> dec_matrix</span><span class="z-keyword z-operator"> @</span><span class="z-source"> p_matrix</span></span>
<span class="giallo-l"><span class="z-source">    matrix</span><span class="z-keyword z-operator"> =</span><span class="z-source"> np</span><span class="z-punctuation">.</span><span class="z-source">linalg</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">inv</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">old_matrix</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Extract the input coordinates and negate the HP latitude,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # since it increases in the opposite direction from RA.</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-support z-function z-builtin z-python"> isinstance</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">data</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">UnitSphericalRepresentation</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-source">        rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">UnitSphericalRepresentation</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">            GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">)</span><span class="z-punctuation z-definition z-comment z-comment">  # , earth_distance(obstime))</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    else</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">SphericalRepresentation</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">            GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">ra</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">dec</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">distance</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Apply the transformation</span></span>
<span class="giallo-l"><span class="z-source">    rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">to_cartesian</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-source">    rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">transform</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">matrix</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Match the input representation. (If the input was UnitSpherical, meaning there&#39;s no</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # distance coordinate, this drops the distance coordinate.)</span></span>
<span class="giallo-l"><span class="z-source">    rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">represent_as</span><span class="z-punctuation">(</span><span class="z-support z-type z-python">type</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">GCRScoord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">data</span><span class="z-punctuation">))</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-support z-function z-builtin z-python"> isinstance</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">rep</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> astropy</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">UnitSphericalRepresentation</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-source">        rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">UnitSphericalRepresentation</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-keyword z-operator">            -</span><span class="z-meta z-function-call z-arguments z-python">rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">lon</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">lat</span><span class="z-punctuation">)</span><span class="z-punctuation z-definition z-comment z-comment">  # , earth_distance(obstime))</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    else</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        rep</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">coordinates</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">SphericalRepresentation</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-keyword z-operator">            -</span><span class="z-meta z-function-call z-arguments z-python">rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">lon</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">lat</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> rep</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">distance</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # Put the computed coordinates into the output frame</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> Helioprojective</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">realize_frame</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">rep</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> calculate_helio_wcs_from_celestial</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">wcs_celestial</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> WCS</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">                                        date_obs</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> datetime</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">                                        data_shape</span><span class="z-punctuation">:</span><span class="z-meta z-indexed-name z-python"> tuple</span><span class="z-punctuation">[</span><span class="z-support z-type z-python">int</span><span class="z-punctuation">,</span><span class="z-support z-type z-python"> int</span><span class="z-punctuation">]) -&gt; (</span><span class="z-source">WCS</span><span class="z-punctuation">,</span><span class="z-support z-type z-python"> float</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">    &quot;&quot;&quot;Calculate the helio WCS from a celestial WCS.&quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    is_3d</span><span class="z-keyword z-operator"> =</span><span class="z-support z-function z-builtin z-python"> len</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">data_shape</span><span class="z-punctuation">)</span><span class="z-keyword z-operator"> ==</span><span class="z-constant z-numeric"> 3</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # we&#39;re at the center of the Earth</span></span>
<span class="giallo-l"><span class="z-source">    test_loc</span><span class="z-keyword z-operator"> =</span><span class="z-source"> EarthLocation</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">from_geocentric</span><span class="z-punctuation">(</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> unit</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">m</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    test_gcrs</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> SkyCoord</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">test_loc</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get_gcrs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">date_obs</span><span class="z-punctuation">))</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # follow the SunPy tutorial from here</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # https://docs.sunpy.org/en/stable/generated/gallery/units_and_coordinates/radec_to_hpc_map.html#sphx-glr-generated-gallery-units-and-coordinates-radec-to-hpc-map-py</span></span>
<span class="giallo-l"><span class="z-source">    reference_coord</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> SkyCoord</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">        wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crval</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Unit</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">cunit</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">]),</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">        wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crval</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Unit</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">cunit</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">]),</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        frame</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;gcrs&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        obstime</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">date_obs</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        obsgeoloc</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">test_gcrs</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">cartesian</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        obsgeovel</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">test_gcrs</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">velocity</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">to_cartesian</span><span class="z-punctuation">(),</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        distance</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">test_gcrs</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">hcrs</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">distance</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation">    )</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    reference_coord_arcsec</span><span class="z-keyword z-operator"> =</span><span class="z-source"> reference_coord</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">transform_to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">frames</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Helioprojective</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">observer</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">test_gcrs</span><span class="z-punctuation">))</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    cdelt1</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation"> (</span><span class="z-source">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">abs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">])</span><span class="z-keyword z-operator"> *</span><span class="z-source"> u</span><span class="z-punctuation">.</span><span class="z-source">deg</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">arcsec</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    cdelt2</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation"> (</span><span class="z-source">np</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">abs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">cdelt</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">])</span><span class="z-keyword z-operator"> *</span><span class="z-source"> u</span><span class="z-punctuation">.</span><span class="z-source">deg</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">arcsec</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    geocentric</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> GCRS</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">obstime</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">date_obs</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    p_angle</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> _sun_north_angle_to_z</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">geocentric</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    rotation_angle</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> extract_crota_from_wcs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-python">to</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">rad</span><span class="z-punctuation">).</span><span class="z-source">value</span><span class="z-keyword z-operator"> +</span><span class="z-meta z-function-call z-python"> get_p_angle</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">date_obs</span><span class="z-punctuation">).</span><span class="z-source">rad</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    new_header</span><span class="z-keyword z-operator"> =</span><span class="z-source"> sunpy</span><span class="z-punctuation">.</span><span class="z-source">map</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">make_fitswcs_header</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-meta z-indexed-name z-python">        data_shape</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">:]</span><span class="z-keyword z-control z-flow z-python"> if</span><span class="z-meta z-function-call z-arguments z-python"> is_3d</span><span class="z-keyword z-control z-flow z-python"> else</span><span class="z-meta z-function-call z-arguments z-python"> data_shape</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-arguments z-python">        reference_coord_arcsec</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        reference_pixel</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Quantity</span><span class="z-punctuation">(</span></span>
<span class="giallo-l"><span class="z-punctuation">            [</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crpix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> -</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">crpix</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> -</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">pixel</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation">        ),</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        scale</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Quantity</span><span class="z-punctuation">([</span><span class="z-meta z-function-call z-arguments z-python">cdelt1</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> cdelt2</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">arcsec</span><span class="z-keyword z-operator"> /</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">pix</span><span class="z-punctuation">),</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        rotation_angle</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">rotation_angle</span><span class="z-keyword z-operator">*</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">rad</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        observatory</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;PUNCH&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        projection_code</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">wcs_celestial</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">wcs</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">ctype</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">][</span><span class="z-keyword z-operator">-</span><span class="z-constant z-numeric">3</span><span class="z-punctuation">:],</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">        unit</span><span class="z-keyword z-operator">=</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-arguments z-python">deg</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation">    )</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    wcs_helio</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> WCS</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">new_header</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-source"> is_3d</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        wcs_helio</span><span class="z-keyword z-operator"> =</span><span class="z-source"> astropy</span><span class="z-punctuation">.</span><span class="z-source">wcs</span><span class="z-punctuation">.</span><span class="z-source">utils</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">add_stokes_axis_to_wcs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">wcs_helio</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 2</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> wcs_helio</span><span class="z-punctuation">,</span><span class="z-source"> p_angle</span></span></code></pre><h2 id="verifying"><a class="header-anchor no-hover-padding" href="#verifying" aria-label="Anchor link for: verifying"><span class="link-icon" aria-hidden="true"></span></a>
Verifying</h2>
<p>We have many tests to verify this works properly.
We use the Sun’s position to go back and forth with known coordinates.
We also test that given an arbitrary WCS you can convert to the other system and then convert back and
get the original input. All our tests pass.</p>
<h2 id="conclusions"><a class="header-anchor no-hover-padding" href="#conclusions" aria-label="Anchor link for: conclusions"><span class="link-icon" aria-hidden="true"></span></a>
Conclusions</h2>
<p>This code was developed for PUNCH to go back and forth between helioprojective and GCRS.
It was used to create some synthetic images that are like what PUNCH will see.
Those files include both a helioprojective and equatorial WCS so you can locate things in context of
the Sun and the stars.</p>
<p>Here’s a sneak peak of what these images look like.</p>
<p><img src="https://jmbhughes.com/blog/converting-coordinates/example_synthetic_PUNCH.png" alt="example synthetic PUNCH image" /></p>
<p>I’ll write more about the synthetic images in the future.</p>

        </section>
        
        

        
            
            
            

            
                
                
            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        
            

<div id="comments" class="comments"


    data-repo="welpo&#x2F;tabi-comments"
    data-repo-id="R_kgDOG3bviQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOG3bvic4CjCSq"
    
        data-mapping="specific"
        data-term="converting-coordinates"
    
    data-strict="1"
    data-reactions-enabled="1"
    
        data-input-position="bottom"
    
    data-light-theme="noborder_light"
    data-dark-theme="noborder_dark"
    
        data-lang="en"
    
    data-lazy-loading="true"
    >




    <script src="https://jmbhughes.com/js/giscus.min.js" async></script>


<noscript>You need JavaScript to view the comments.</noscript>
</div>

        </article>
</main>

    <div id="button-container">
        
        
            <div id="toc-floating-container">
                <input type="checkbox" id="toc-toggle" class="toggle"/>
                <label for="toc-toggle" id="toc-button" class="button" title="Toggle Table of Contents">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg>
                </label>
                <div class="toc-content">
                    

<div class="toc-container">
    

    <ul>
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#introduction">Introduction</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#converting-a-single-coordinate">Converting a single coordinate</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#transforming-a-wcs-from-helio-to-celestial">Transforming a WCS from helio to celestial</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#transforming-the-opposite-direction">Transforming the opposite direction</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#verifying">Verifying</a>
                    
                </li>
            
        
            
            
                <li><a href="https://jmbhughes.com/blog/converting-coordinates/#conclusions">Conclusions</a>
                    
                </li>
            
        
    </ul>
</div>


                </div>
            </div>
        

        
        <a href="#comments" id="comments-button" class="no-hover-padding" title="Go to the comments section">
                <svg viewBox="0 0 20 20" fill="currentColor"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" fill-rule="evenodd"/></svg>
            </a>
        

        
        <a href="#" id="top-button" class="no-hover-padding" title="Go to the top of the page">
            <svg viewBox="0 0 20 20" fill="currentColor"><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg>
        </a>
    </div>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://jmbhughes.com/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs"><ul><li>
                        <a class="nav-links no-hover-padding social" rel="" 

 href="https://jmbhughes.com/atom.xml">
                        <img loading="lazy" alt="feed" title="feed" src="https://jmbhughes.com/social_icons/rss.svg">
                        </a>
                    </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel=" me" 

 href="https://github.com/jmbhughes">
                                    <img loading="lazy" alt="github" title="github" src="https://jmbhughes.com/social_icons/github.svg">
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel=" me" 

 href="https://scholar.google.com/citations?user=YjcQEIkAAAAJ&hl=en">
                                    <img loading="lazy" alt="google-scholar" title="google-scholar" src="https://jmbhughes.com/social_icons/google-scholar.svg">
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel=" me" 

 href="mailto:marcus@jmbhughes.com">
                                    <img loading="lazy" alt="email" title="email" src="https://jmbhughes.com/social_icons/email.svg">
                                </a>
                            </li>
                        
                    
                </ul>
            
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                
    
    
    
    
        
    
        
    

    

    
    
    

    
    
    <p><p>© 2026 J. Marcus Hughes • Unless otherwise noted, the content in this website is available under the <a class="external" rel="external" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license.</p>
</p>

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                •
                    <a rel="" 

 href="https:&#x2F;&#x2F;github.com&#x2F;jmbhughes&#x2F;jmbhughes.github.io">
                        Site source
                    </a></small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
